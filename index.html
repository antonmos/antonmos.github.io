<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Boat Simulation</title>
</head>
<style>
  .container {
    display: flex;
  }

  .child {
    width: 200px;
    margin: auto;
  }

  canvas#canvas {
    border: 1px solid black;
  }

  .instruments {
    display: flex;
    flex-direction: column;
  }

  .instruments .child {
    padding-top: 20px;
  }

  .instruments .heading {
    font-weight: bold;
    padding-bottom: 5px;
  }
  .instruments input[type=number] {
    width: 80px;
  }
</style>
<body>
<div class="container">
  <canvas class="child" id="canvas" width="600" height="600"></canvas>
  <div class="child">
    <div class="instruments">
      <div class="child">
        <div class="heading">Boat:</div>
        <div>
          <label for="boat-speed">Speed</label>
          <input type="number" id="boat-speed" min="0" max="100">
        </div>
        <div>
          <label for="boat-direction">Direction</label>
          <input type="number" id="boat-direction" min="0" max="360">
        </div>
      </div>
      <div class="child">
        <div class="heading">Current:</div>
        <div>
          <label for="current-speed">Speed</label>
          <input type="number" id="current-speed" readonly>
        </div>
        <div>
          <label for="current-direction">Direction</label>
          <input type="number" id="current-direction" readonly>
        </div>
      </div>
      <div class="child">
        <label for="disable-current">Disable current</label>
        <input id="disable-current" type="checkbox" onclick="run()">
      </div>
      <div class="child">
        <input type="button" value="Run" onclick="run()">
        <input type="button" value="Reset" onclick="reset()">
      </div>
    </div>
  </div>
</div>

<!-- Get latest version: https://cdnjs.com/libraries/fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/521/fabric.min.js" integrity="sha512-nPzvcIhv7AtvjpNcnbr86eT6zGtiudLiLyVssCWLmvQHgR95VvkLX8mMpqNKWs1TG3Hnf+tvHpnGmpPS3yJIgw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  function easeLinear(t, b, c, d) {
    return b + (t/d) * c;
  }
  function moveBoatToStart(boat) {
    boat.set({'left': 350, 'top': 450});
  }
  function initCanvas(canvas) {
    canvas.clear();
    const island = new fabric.Circle({
      radius: 30, fill: 'green', left: 100, top: 100
    });
    canvas.add(island);
    const boat = new fabric.Triangle({
      width: 20, height: 30, fill: 'blue'
    });
    moveBoatToStart(boat);
    canvas.add(boat);
    return [boat, island];
  }
  let boat = null, island = null;
  let stopBoat = null;
  function reset() {
    fabric.runningAnimations.cancelAll();
    [boat, island] = initCanvas(canvas);
    currentDirection.value = Math.round(Math.random() * 360);
    currentSpeed.value = Math.round(Math.random() * 100);
    boatDirection.value = 0;
    boatSpeed.value = 0;
  }

  function calcSpeedComponent(speed, angle, type) {
    const trigFn = type === 'x' ? Math.cos : Math.sin;
    return speed * trigFn(-angle * Math.PI / 180);
  }

  function calcDelta(type) {
    const time = 5;
    const boatComponent = calcSpeedComponent(boatSpeed.value, boatDirection.value, type);
    const boatDelta = time * boatComponent;
    console.log("boatDelta", boatDelta)

    if (disableCurrent.checked) {
      return boatDelta;
    }
    const currentComponent = calcSpeedComponent(currentSpeed.value, currentDirection.value, type);
    return boatDelta + time * currentComponent;
  }

  function run() {
    fabric.runningAnimations.cancelAll();
    moveBoatToStart(boat);
    const finalX = boat.get('left') + calcDelta('x');
    const finalY = boat.get('top') + calcDelta('y')
    stopBoat = boat.animate({'left': finalX, 'top': finalY}, {
      onChange: canvas.renderAll.bind(canvas),
      duration: 10000,
      easing: easeLinear,
      abort: () => { return boat.intersectsWithObject(island); }
    });
  }

  const currentDirection = document.getElementById('current-direction');
  const currentSpeed = document.getElementById('current-speed');
  const boatDirection = document.getElementById('boat-direction');
  const boatSpeed = document.getElementById('boat-speed');
  const disableCurrent = document.getElementById('disable-current');
  const canvas = new fabric.Canvas('canvas');
  reset();
</script>

</body>
</html>
