<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Boat Simulation</title>
</head>
<style>
  .container {
    display: flex;
  }

  .child {
    width: 200px;
    margin: auto;
  }

  canvas#canvas {
    border: 1px solid black;
  }

  .instruments {
    display: flex;
    flex-direction: column;
  }

  .instruments .child {
    padding-top: 20px;
  }

  .instruments .heading {
    font-weight: bold;
    padding-bottom: 5px;
  }
  .instruments input[type=number] {
    width: 80px;
  }
</style>
<body>
<div class="container">
  <canvas class="child" id="canvas" width="600" height="600"></canvas>
  <div class="child">
    <div class="instruments">
      <div class="child">
        <div class="heading">Boat:</div>
        <div>
          <label for="boat-speed">Speed</label>
          <input type="number" id="boat-speed" min="0" max="100">
        </div>
        <div>
          <label for="boat-direction">Direction</label>
          <input type="number" id="boat-direction" min="0" max="360">
        </div>
      </div>
      <div class="child">
        <div class="heading">Current:</div>
        <div>
          <label for="current-speed">Speed</label>
          <input type="number" id="current-speed" readonly>
        </div>
        <div>
          <label for="current-direction">Direction</label>
          <input type="number" id="current-direction" readonly>
        </div>
      </div>
      <div class="child">
        <label for="disable-current">Disable current</label>
        <input id="disable-current" type="checkbox">
      </div>
      <div class="child">
        <input type="button" value="Run" onclick="run()">
        <input type="button" value="Stop" onclick="stop()">
        <input type="button" value="Start over" onclick="startOver()">
      </div>
    </div>
  </div>
</div>

<!-- Get latest version: https://cdnjs.com/libraries/fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/521/fabric.min.js" integrity="sha512-nPzvcIhv7AtvjpNcnbr86eT6zGtiudLiLyVssCWLmvQHgR95VvkLX8mMpqNKWs1TG3Hnf+tvHpnGmpPS3yJIgw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  function easeLinear(t, b, c, d) {
    return b + (t/d) * c;
  }
  function moveBoatToStart(boat) {
    boat.set({'left': 350, 'top': 450});
  }
  function initCanvas(canvas) {
    canvas.clear();
    const island = new fabric.Rect({
      height: 40, width: 40, fill: 'green', left: 100, top: 100
    });
    canvas.add(island);
    const boat = new fabric.Triangle({
      width: 20, height: 30, fill: 'blue'
    });
    moveBoatToStart(boat);
    canvas.add(boat);
    return [boat, island];
  }
  let boat = null, island = null;
  let finished = false;
  function startOver() {
    stop();
    [boat, island] = initCanvas(canvas);
    currentDirection.value = Math.round(Math.random() * 360);
    currentSpeed.value = Math.round(Math.random() * 100);
    boatDirection.value = 0;
    boatSpeed.value = 0;
  }

  function calcSpeedComponent(speed, angle, type) {
    const trigFn = type === 'x' ? Math.cos : Math.sin;
    return speed * trigFn(-angle * Math.PI / 180);
  }

  function calcDelta(type) {
    const time = 5;
    console.log("calcDelta")
    const boatComponent = calcSpeedComponent(boatSpeed.value, boatDirection.value, type);
    const boatDelta = time * boatComponent;
    if (disableCurrent.checked) {
      return boatDelta;
    }
    const currentComponent = calcSpeedComponent(currentSpeed.value, currentDirection.value, type);
    return boatDelta + time * currentComponent;
  }

  function stop() {
    fabric.runningAnimations.cancelAll();
  }
  function run() {
    stop();
    finished = false;
    moveBoatToStart(boat);
    const startX = boat.get('left');
    const startY = boat.get('top');
    const deltaX = calcDelta('x');
    const deltaY = calcDelta('y');

    const hypo = Math.sqrt(Math.pow(deltaX, 2) + Math.pow(deltaY, 2));
    const angle = Math.acos(deltaX/hypo)
    boat.animate('angle',90 - (angle * 180 / Math.PI), {onChange: canvas.renderAll.bind(canvas)});
    boat.animate({'left': startX + deltaX, 'top': startY + deltaY }, {
      onChange: canvas.renderAll.bind(canvas),
      duration: 5000,
      easing: easeLinear,
      abort: function abort() {
        boat.setCoords();
        island.setCoords();
        if (boat.intersectsWithObject(island)) {
          if (!finished) {
            alert("You made it to the shore!");
            finished = true;
          }
          return true;
        } else if (!boat.isOnScreen()) {
           if (!finished) {
            alert("You fell of the edge of the world!");
            finished = true;
          }
          return true;
        }
      }
    });
  }

  const currentDirection = document.getElementById('current-direction');
  const currentSpeed = document.getElementById('current-speed');
  const boatDirection = document.getElementById('boat-direction');
  const boatSpeed = document.getElementById('boat-speed');
  const disableCurrent = document.getElementById('disable-current');
  const canvas = new fabric.Canvas('canvas');
  startOver();
</script>

</body>
</html>
